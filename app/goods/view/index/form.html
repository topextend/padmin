{extend name="../../admin/view/main"}
{block name="button"}
    <button data-open='{:url("index")}' class='layui-btn layui-btn-sm layui-btn-primary'>返回</button>
{/block}
{block name="content"}
    {include file='index/formstyle'}
    <form onsubmit="return false" data-auto="true" method="post" class='layui-form layui-card layui-form-pane' autocomplete="off">
        <div class="layui-card-body">
            <div class="layui-form-item">
                <label class="layui-form-label"><b>商品分类</b></label>
                <div class="layui-input-inline"><span class="layui-input">{$select_cats|raw}</span></div>
                <a data-open='{:url("category")}' class="layui-btn layui-btn-radius layui-btn-danger"><span>修改分类</span></a>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label"><b>商品属性</b></label>
                <div class="layui-input-block">
                    <table class="layui-table">
                        <thead>
                            <tr><th class="text-left">请准确填写属性，有利于商品在搜索和推荐中露出，错误填写可能面临商品下架或流量损失!</th></tr>
                            <tr>
                                <td class="text-left">
                                    <div class="layui-row margin-top-10">
                                        <div class="layui-col-md4 margin-bottom-15">
                                            <label class="layui-form-label">商品货号</label>
                                            <div class="layui-input-inline">
                                                <input type="text" name="goods_sn" value='{$vo.goods_sn|default=""}' required lay-verify="required" lay-vertype="tips" placeholder="请输入商品货号" autocomplete="off" class="layui-input">
                                            </div>
                                        </div>
                                        <div class="layui-col-md4 margin-bottom-15">
                                            <label class="layui-form-label">商品重量</label>
                                            <div class="layui-input-inline" style="width: 153px;margin-right: -1px;">
                                                <input type="text" name="goods_weight" value='{$vo.goods_weight|default=""}' required lay-verify="required" lay-vertype="tips" placeholder="请输入商品重量" autocomplete="off" class="layui-input" style="width: 153px;">
                                            </div>
                                            <div class="layui-form-mid layui-form-label layui-word-aux" style="width: 10%;">克</div>
                                        </div>
                                        <div class="layui-col-md4 margin-bottom-15">
                                            <label class="layui-form-label">品牌</label>
                                            <div class="layui-input-inline">
                                                <select name="brand_id" required lay-verify="required" lay-search>
                                                    <option value="0">请选择品牌</option>
                                                    <!-- {notempty name='goods_brand'} -->
                                                        <!-- {foreach $goods_brand as $brand} -->
                                                            <!-- {eq name='brand.id' value='$vo.brand_id|default=0'} -->
                                                                <option selected value='{$brand.id}'>{$brand.brand_name}</option>
                                                            <!-- {else} -->
                                                                <option value='{$brand.id}'>{$brand.brand_name}</option>
                                                            <!-- {/eq} -->
                                                        <!-- {/foreach} -->
                                                    <!-- {/notempty} -->
                                                </select>
                                            </div>
                                        </div>
                                        <div class="layui-col-md4 margin-bottom-15">
                                            <label class="layui-form-label">仓库</label>
                                            <div class="layui-input-inline">
                                                <select name="whouse_id" required lay-verify="required" lay-search>
                                                    <option value="0">请选择仓库</option>
                                                    <!-- {notempty name='goods_whouses'} -->
                                                        <!-- {foreach $goods_whouses as $whouse} -->
                                                            <!-- {eq name='whouse.id' value='$vo.whouse_id|default=0'} -->
                                                                <option selected value='{$whouse.id}'>{$whouse.whouse_name}</option>
                                                            <!-- {else} -->
                                                                <option value='{$whouse.id}'>{$whouse.whouse_name}</option>
                                                            <!-- {/eq} -->
                                                        <!-- {/foreach} -->
                                                    <!-- {/notempty} -->
                                                </select>
                                            </div>
                                        </div>
                                        <!-- {notempty name='goods_attr'} -->
                                            <!-- {foreach $goods_attr as $key => $attr} -->
                                                <!-- {eq name='attr.attr_type' value='1'} -->
                                                    <div class="layui-col-md4 margin-bottom-15">
                                                        <label class="layui-form-label">{$attr.attr_name}</label>
                                                        <div class="layui-input-inline">
                                                            <input type="hidden" name='attr_id[]' value="{$attr.id}">
                                                            <select name="attr_value[]"class="layui-input layui-unselect">
                                                                <option value="0">请选择</option>
                                                                <!-- {foreach $attr.attr_values as $value} -->
                                                                    <!-- {notempty name='attr_value'} -->
                                                                        <!-- {if in_array($value, $attr_value)} -->
                                                                            <option selected value='{$value}'>{$value}</option>
                                                                        <!-- {else} -->
                                                                            <option value='{$value}'>{$value}</option>
                                                                        <!-- {/if} -->
                                                                    <!-- {else} -->
                                                                        <option value='{$value}'>{$value}</option>
                                                                    <!-- {/notempty} -->
                                                                <!-- {/foreach} -->
                                                            </select>
                                                        </div>
                                                    </div>
                                                <!-- {/eq} -->
                                            <!-- {/foreach} -->
                                        <!-- {/notempty} -->
                                    </div>
                                </td>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label"><b>商品图片</b></label>
                <div class="layui-input-block">
                    <table class="layui-table">
                        <thead>
                            <tr><th class="text-left label-required-prev"><label>轮播图</label></th></tr>
                            <tr>
                                <td class="text-left"><input data-upload-images name="goods_img" type="hidden" value="{$goods_imgs|default=''}"></td>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label"><b>商品规格</b></label>
                <div class="layui-input-block goods-spec-list">
                    <!-- {notempty name='goods_attr'} -->
                        <!-- {foreach $goods_attr as $key => $attrs} -->
                            <!-- {eq name='attrs.attr_type' value='0'} -->
                                <!-- {if $key == 0} -->
                                    <div class="colorblock">
                                        <div class="goods-spec-attr goods-spec-box margin-0 relative" style="background:#eee;padding: 7px!important;">
                                            <span class="text-center">{$attrs.attr_name}</span>
                                            <span class="margin-left-10 color-desc font-s10">{$attrs.attr_notice}</span>                    
                                        </div>
                                        <div class="goods-spec-value padding-10 margin-0 layui-bg-gray block relative">
                                            <div class="color-group-wrapper color-dropdown-wrapper colordrop" style="display: none;">
                                                <div class="colorleft">
                                                    <ul class="color-group-panel">
                                                        {foreach $attrs.attr_values as $k => $colors}
                                                        <li class="color-tag" index-data="{$k}">
                                                            <a><div class="color-block" style="background:rgb(255, 255, 255);"></div><span>{$colors.name}</span></a>
                                                        </li>
                                                        {/foreach}
                                                    </ul>
                                                </div>
                                                <div class="colors-panel coloright">
                                                    <p class="colors-panel-title">常用标准颜色</p>
                                                    <div class="colorval">                                                        
                                                        {foreach $attrs.attr_values as $k => $colors}
                                                        <ul class="color-list index{$k}" {gt name="k" value="0"}style="display: none;"{/gt}>
                                                            {foreach $colors.values as $kk => $color}
                                                            <li class="color-tag" data-id="{$kk}">
                                                                <a><div class="color-block" style="background:rgb(255, 251, 240);"></div><span>{$color}</span></a>
                                                            </li>
                                                            {/foreach}
                                                        </ul>
                                                        {/foreach}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                <!-- {else} -->
                                <div class="sizeblock">                
                                    <div class="goods-spec-attr goods-spec-box margin-0 relative" style="background:#eee;padding: 7px!important;">
                                        <span class="text-center">{$attrs.attr_name}</span>
                                        <span class="margin-left-10 color-desc font-s10">{$attrs.attr_notice}</span>                    
                                    </div>
                                    <div class="goods-spec-value padding-10 margin-0 layui-bg-gray block relative">
                                        <div class="layui-tab layui-tab-card divsize" lay-filter="divsize">
                                            <ul class="layui-tab-title">
                                                {foreach $attrs.attr_values as $k => $sizes}
                                                <li lay-id="{$k}" {eq name="k" value="0"}class="layui-this"{/eq}>{$sizes.name}</li>
                                                {/foreach}
                                            </ul>
                                        </div>
                                        <div class="sizeinput">
                                            <input type="text" name="inputsize" placeholder="请输入自定义值" class="layui-input inputsize">
                                            <div class="layui-btn layui-btn-primary layui-btn-sm adsize">+添加</div>
                                        </div>
                                        <div data-item-size>   
                                            {foreach $attrs.attr_values as $k => $sizes}                                         
                                            <div class="goods-spec-name layui-row margin-top-10 index{$k}" {gt name="k" value="0"}style="display: none;"{/gt}>
                                                {foreach $sizes.values as $kk => $size}
                                                <div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
                                                    <input type="checkbox" name="spec-size" title="{$size}" lay-filter="size" lay-skin="primary" value="{$kk}">
                                                    <input type="text" class="goods-spec-note layui-input margin-left-5 layui-hide">
                                                </div>
                                                {/foreach}
                                            </div>
                                            {/foreach}
                                        </div>
                                    </div>
                                </div>
                                <!-- {/if} -->
                            <!-- {/eq} -->
                        <!-- {/foreach} -->
                    <!-- {/notempty} -->
                    <table class="layui-table viewatttable">
                        <thead>
                            <tr>
                                <!-- {notempty name='goods_attr'} -->
                                    <!-- {foreach $goods_attr as $key => $attrs} -->
                                        <!-- {eq name='attrs.attr_type' value='0'} -->
                                            <th width="20%" class="text-center nowrap">{$attrs.attr_name}</th>
                                        <!-- {/eq} -->
                                    <!-- {/foreach} -->
                                <!-- {/notempty} -->
                                <th width="15%" class="text-center nowrap">销售价格<a data-tips-text="批量设置" class="layui-icon" onclick="bachset('shop_price')">&#xe63c;</a></th>
                                <th width="15%" class="text-center nowrap">分销价格<a data-tips-text="批量设置" class="layui-icon" onclick="bachset('stock_price')">&#xe63c;</a></th>
                                <th width="15%" class="text-center nowrap">库存<a data-tips-text="批量设置" class="layui-icon" onclick="bachset('goods_amount')">&#xe63c;</a></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label"><b>商品详情</b></label>
                <div class="layui-input-block"><textarea name="content">{$goods_content|default=''|raw}</textarea></div>
            </div>
            <div data-input-color class="layui-hide">
                <div class="layui-display-flex divcolor">
                    <div class="goods-spec-color">
                        <input type="text" name="attr-value[]" autocomplete="off" placeholder="选择或输入主色" class="layui-input colour">
                    </div>
                    <div class="goods-spec-note margin-left-10">
                        <input type="text" name="attr-value-note[]" placeholder="备注(如偏深偏浅等)" autocomplete="off" class="layui-input">
                    </div>
                    <div class="goods-spce-image margin-left-10">
                        <input data-upload-image name="img[]" type="hidden">
                    </div>
                    <div class="goods-spec-del margin-left-10" style="line-height: 38px;"></div>
                </div>
            </div>
            <label class="layui-hide">
                <textarea id="DefaultData">{$data|default=[]|json_encode}</textarea>
            </label>
            {notempty name='vo.goods_id'}<input type='hidden' value='{$vo.goods_id}' name='goods_id'>{/notempty}
            <input type='hidden' value='{$vo.cat_id|default=input("cat_id",0)}' name='cat_id'>
            <input type='hidden' value='{:session("user.id")}' name='user_id'>
            <div class="layui-form-item text-center">
                <button class="layui-btn" type='submit'>保存数据</button>
                <button class="layui-btn layui-btn-danger" type='button' data-open='{:url("index")}'>取消编辑</button>
            </div>
        </div>
    </form>
{/block}
{block name='script'}
<script>
    (function(data) {
        /*! 表单初始化 */
        window.form.render();
        /*! 加载扩展插件 */
        require(['ckeditor', 'angular'], function () {
            // 富文本加载
            window.createEditor('[name="content"]', {height: 400});
        });
        /*! 默认数据渲染 */
        if (data.length < 1) addColorItem();
        else data.forEach(function (item) {
            addColorItem(item)
        });
        /*! 初始化上传插件 */
        (function initUpload() {
            $('.goods-spec-value input[data-upload-image]').map(function () {
                if (!$(this).attr('inited')) $(this).attr('inited', true).uploadOneImage();
            });
            $('.layui-table input[data-upload-images]').map(function () {
                if (!$(this).attr('inited')) $(this).attr('inited', true).uploadMultipleImage();
            });
            setTimeout(initUpload, 50);
        })();
        /*! 显示颜色框*/
        var colorBlock = $(".colorblock .goods-spec-value");
        colorBlock.delegate(".colour","click",function(){
            if($.trim($(this).val()).length == 0) {
                var index = colorBlock.find(".colour").index(this);
                colorBlock.find(".colordrop").show().css("top",index*45+45);
            }
            $(this).addClass("selected").parents(".divcolor").siblings().find(".colour").removeClass("selected");
            $(this).keyup(function(){
                if($.trim($(this).val()).length==0){
                    $(".viewatttable tbody .tr_"+colorBlock.find(".colour").index(this)).remove();
                    checkistable();
                }
            });
        }).delegate(".colordrop", "mouseleave", function(){
            colorBlock.find(".colordrop").hide();
        }).delegate(".colour", "blur", function() {
            if($.trim($(this).val()).length > 0) {
                checkcolor();
            }
        });
        /*!  颜色值点击*/
        colorBlock.find(".colorval ul li").click(function(){
            if(checkval($(this).text(),'color') == true){
                layer.tips('与其他颜色重复，请修改!', $(this),{tips:[2,"#FF6A6A"]});
                return false;
            };
            colorBlock.find(".colour.selected").val($(this).text());
            colorBlock.find(".colour.selected").attr("data-id",$(this).attr("data-id"));
            checkcolor();
        });
        /*! 颜色左边移动*/
        $(".colorblock .colorleft ul li").mouseover(function(){
            var nums = parseInt($(this).attr("index-data"));
            $(".colorblock .coloright .colorval ul").each(function(index){
                if(nums == index){
                    $(this).show().siblings().hide();
                }
            })
        });
        /*! 删除颜色*/
        $(".colorblock").delegate(".goods-spec-del a","click",function(){
            var remove_key = $(".colorblock .goods-spec-del a").index(this);
            $(this).parents(".divcolor").remove();
            $(".colorblock .colordrop").hide();
            // 删除表格属性
			IsmakeProducttable(remove_key,4);
        });
        // 切换码型
        layui.use('element', function() {
            var element = layui.element;
            //监听Tab切换
            element.on('tab(divsize)', function(){
                var layid = this.getAttribute('lay-id');
                layer.open({
                    type: 1
                    ,title: '确认切换'
                    ,closeBtn: false
                    ,area: '300px;'
                    ,shade: 0.8
                    ,id: 'LAY_layuipro'
                    ,btn: ['确认', '取消']
                    ,btnAlign: 'c'
                    ,moveType: 1
                    ,content: '<div style="padding:20px;line-height:22px;background-color:#fff;border-bottom:1px solid #eee;color:#000;font-weight:300;">切换尺码分组将会丢失勾选的尺码及 商品属性 数据，确定切换？</div>'
                    ,yes: function(index){
                        $("[data-item-size]").find(".index" + layid).show().siblings().hide();
                        $("[data-item-size] input[name='spec-size']").each(function(){
                            this.checked=false;
                            $(this).siblings(".goods-spec-note").addClass('layui-hide');
                        });
					    $(".viewatttable").find("tbody").html("");
					    layer.close(index);
                    }
                });
                form.render('checkbox');
            });
        });
        // 尺码勾选
        form.on('checkbox(size)', function(data){
            if(this.checked){
                $(this).siblings(".goods-spec-note").removeClass('layui-hide');
				IsmakeProducttable($("input[name='spec-size']:checked").index(this),5);
            } else {
                $(this).siblings(".goods-spec-note").addClass('layui-hide');
				var thisc = 0;
				var tvalue = this.value;
				$(this).parents("[data-item-size]").find("input[name='spec-size']").each(function(){
					if(tvalue == $(this).val()){
						return false;
					}
                    console.log(tvalue);
					if($(this).is(":checked")){
						thisc++;
					}
                });
				IsmakeProducttable(thisc,6);
            }
        });
        // 增加自定义尺码
        $(".sizeblock .adsize").click(function(){
            var inputsize= $(".sizeblock .inputsize").val();
            if(checkval(inputsize,'size') == true){
                layer.tips('与其他尺码重复，请修改!', $(this),{tips:[2,"#FF6A6A"]});
                return false;
            };
            var nt = 0;
            $(".sizeblock .divsize ul li").each(function(){
                if($(this).hasClass('layui-this')){
                    var adinputsize = '<div class="layui-col-xs6 layui-col-sm6 layui-col-md4 newsize">';
                        adinputsize+= '<input type="checkbox" name="spec-size" title="'+ inputsize +'" lay-filter="size" lay-skin="primary" value="'+ inputsize +'">';
                        adinputsize+= '<input type="text" name="spec-note" class="goods-spec-notes layui-input margin-left-5">';
                        adinputsize+= '<a class="layui-btn layui-btn-primary layui-btn-xs margin-top-10 margin-left-10 size-del"><i class="layui-icon">&#xe640;</i></a>';
                        adinputsize+= '</div>';
                    $("[data-item-size] .goods-spec-name").eq(nt).append(adinputsize);
                }
                nt++;
            });
			$(".sizeblock .inputsize").val('');
            form.render();
        });
        $("[data-item-size]").delegate(".newsize .size-del","click",function(){
            if($(this).siblings("input[name='spec-size']").is(':checked')==true){
                layer.tips('请勾除尺码', $(this),{tips:[2,"#FF6A6A"]});
                return false;
            } else {
                $(this).parents(".newsize").remove();
            }            
        });
    })(JSON.parse($('#DefaultData').val() || '[]') || []);    
    /*! 检测表格*/
    function IsmakeProducttable(key,num){
        if(checkistable() == false){
            return false;
        }
        var st_sizecount = $("[data-item-size] input[name='spec-size']:checked").size();
        if(num == 1){
            var all_size = $(".viewatttable tbody .att_size").size();
            var valid_count = GetCountColor()-1;
            var average = all_size/valid_count;
            var st_color = $(".colorblock .goods-spec-value .colour").eq(key).val();
            var tbodystr='';
            $("[data-item-size] input[name='spec-size']:checked").each(function(index){
                var st_tr = index == 0 ? '<tr><td rowspan="'+ st_sizecount +'" class="layui-bg-gray text-center att_color">'+ st_color + '</td>' : '<tr>';
                    tbodystr += (st_tr+
                        '<td class="layui-bg-gray text-center att_size">'+ $("[data-item-size] input[name='spec-size']:checked").eq(index).attr("title") + '</td>'+
                        '<td class="padding-0"><label class="padding-0 margin-0">'+
                        '<input class="layui-input border-0 padding-left-0 text-center ng-pristine ng-valid ng-not-empty ng-touched" name="shop_price[]" value="0">'+
                        '</label></td>'+
                        '<td class="padding-0"><label class="padding-0 margin-0">'+
                        '<input class="layui-input border-0 padding-left-0 text-center ng-pristine ng-valid ng-not-empty ng-touched" name="stock_price[]" value="0">'+
                        '</label></td>'+
                        '<td class="padding-0"><label class="padding-0 margin-0">'+
                        '<input class="layui-input border-0 padding-left-0 text-center ng-pristine ng-valid ng-not-empty ng-touched" name="goods_amount[]" value="0">'+
                        '</label></td>'+
                    '</tr>');
            });
            if(key == 0) $(".viewatttable tbody").prepend(tbodystr); else $(".viewatttable tbody tr").eq(key*average-1).after(tbodystr);
        } else if(num == 2){
            var st_color = $(".colorblock .goods-spec-value .colour").eq(key).val();
            var tbodystr='';
            $("[data-item-size] input[name='spec-size']:checked").each(function(index){
                var st_tr = index == 0 ? '<tr><td rowspan="'+ st_sizecount +'" class="layui-bg-gray text-center att_color">'+ st_color + '</td>' : '<tr>';
                    tbodystr += (st_tr+
                        '<td class="layui-bg-gray text-center att_size">'+ $("[data-item-size] input[name='spec-size']:checked").eq(index).attr("title") + '</td>'+
                        '<td class="padding-0"><label class="padding-0 margin-0">'+
                        '<input class="layui-input border-0 padding-left-0 text-center ng-pristine ng-valid ng-not-empty ng-touched" name="shop_price[]" value="0">'+
                        '</label></td>'+
                        '<td class="padding-0"><label class="padding-0 margin-0">'+
                        '<input class="layui-input border-0 padding-left-0 text-center ng-pristine ng-valid ng-not-empty ng-touched" name="stock_price[]" value="0">'+
                        '</label></td>'+
                        '<td class="padding-0"><label class="padding-0 margin-0">'+
                        '<input class="layui-input border-0 padding-left-0 text-center ng-pristine ng-valid ng-not-empty ng-touched" name="goods_amount[]" value="0">'+
                        '</label></td>'+
                    '</tr>');
            });
            $(".viewatttable tbody").append(tbodystr);
        } else if(num == 3){
            var all_size = $(".viewatttable tbody .att_size").size();
            var valid_count = GetCountColor()+1;
            var average = all_size/valid_count;
            for(var i=key*average+average-1;i>=key*average;i--){
                $(".viewatttable tbody tr").eq(i).remove();
            }
            form.render();
            $(".viewatttable tbody .tr_"+key).remove();
        } else if(num == 4){
            var all_size = $(".viewatttable tbody .att_size").size();
            var valid_count = GetCountColor()+1;
            var average = all_size/valid_count;
            for(var i=key*average+average-1;i>=key*average;i--){
                $(".viewatttable tbody tr").eq(i).remove();
            }
            form.render();
        } else if(num == 5){
            var checktbody = $.trim($(".viewatttable tbody").html()).length;
            if(checktbody==0){
                var tbodystr='';
                var usecolorkey= 0;
                $(".colorblock .goods-spec-value .colour").each(function(){
                    thatcolor = $(this);
                    if($.trim($(this).val()).length > 0){
                        $("[data-item-size] input[name='spec-size']:checked").each(function(index){
                            tbodystr += ('<tr>'+
                                '<td rowspan="1" class="layui-bg-gray text-center att_color">'+ thatcolor.val() + '</td>'+
                                '<td class="layui-bg-gray text-center att_size">'+ $("[data-item-size] input[name='spec-size']:checked").eq(index).attr("title") + '</td>'+
                                '<td class="padding-0"><label class="padding-0 margin-0">'+
                                '<input class="layui-input border-0 padding-left-0 text-center ng-pristine ng-valid ng-not-empty ng-touched" name="shop_price[]" value="0">'+
                                '</label></td>'+
                                '<td class="padding-0"><label class="padding-0 margin-0">'+
                                '<input class="layui-input border-0 padding-left-0 text-center ng-pristine ng-valid ng-not-empty ng-touched" name="stock_price[]" value="0">'+
                                '</label></td>'+
                                '<td class="padding-0"><label class="padding-0 margin-0">'+
                                '<input class="layui-input border-0 padding-left-0 text-center ng-pristine ng-valid ng-not-empty ng-touched" name="goods_amount[]" value="0">'+
                                '</label></td>'+
                                '</tr>');
                        });
                        usecolorkey++;
                    }
                });
                $(".viewatttable tbody").append(tbodystr);
            } else {
                var all_size = $(".viewatttable tbody .att_size").size();
                var valid_count = GetCountColor();
                var average = all_size/valid_count;
                var digit = parseInt($(".viewatttable tbody tr").eq(0).find("td").attr("rowspan"));
                for(var i=1;i<=valid_count;i++){
                    var skey = i*average-average;
                    var starkey = (i == 1 ? skey : skey+i-2);
                    var start_key = (i == 1 ? key-1 : starkey+key);
                    if(key != 0){
                        $(".viewatttable tbody tr").eq(start_key).after('<tr>'+
                            '<td class="layui-bg-gray text-center att_size">'+ $("[data-item-size] input[name='spec-size']:checked").eq(key).attr("title") + '</td>'+
                            '<td class="padding-0"><label class="padding-0 margin-0">'+
                            '<input class="layui-input border-0 padding-left-0 text-center ng-pristine ng-valid ng-not-empty ng-touched" name="shop_price[]" value="0">'+
                            '</label></td>'+
                            '<td class="padding-0"><label class="padding-0 margin-0">'+
                            '<input class="layui-input border-0 padding-left-0 text-center ng-pristine ng-valid ng-not-empty ng-touched" name="stock_price[]" value="0">'+
                            '</label></td>'+
                            '<td class="padding-0"><label class="padding-0 margin-0">'+
                            '<input class="layui-input border-0 padding-left-0 text-center ng-pristine ng-valid ng-not-empty ng-touched" name="goods_amount[]" value="0">'+
                            '</label></td>'+
                        '</tr>');
                        var eqstar = (i == 1 ? starkey : starkey+1);
                        $(".viewatttable tbody tr").eq(eqstar).find("td").eq(0).attr("rowspan",digit+1);
                    }else{
                        start_key = (i == 1 ? 0 : skey+i-1);
                        var rowspan = $(".viewatttable tbody tr").eq(start_key).find("td").eq(0).attr("rowspan");
                        rowspan = parseInt(rowspan)+1;
                        var row_color = $(".viewatttable tbody tr").eq(start_key).find("td").eq(0).html();
                        $(".viewatttable tbody tr").eq(start_key).find("td").eq(0).remove();
                        $(".viewatttable tbody tr").eq(start_key).before('<tr>'+
                            '<td rowspan="'+rowspan+'" class="layui-bg-gray text-center att_color">'+ row_color + '</td>'+
                            '<td class="layui-bg-gray text-center att_size">'+ $("[data-item-size] input[name='spec-size']:checked").eq(key).attr("title") + '</td>'+
                            '<td class="padding-0"><label class="padding-0 margin-0">'+
                            '<input class="layui-input border-0 padding-left-0 text-center ng-pristine ng-valid ng-not-empty ng-touched" name="shop_price[]" value="0">'+
                            '</label></td>'+
                            '<td class="padding-0"><label class="padding-0 margin-0">'+
                            '<input class="layui-input border-0 padding-left-0 text-center ng-pristine ng-valid ng-not-empty ng-touched" name="stock_price[]" value="0">'+
                            '</label></td>'+
                            '<td class="padding-0"><label class="padding-0 margin-0">'+
                            '<input class="layui-input border-0 padding-left-0 text-center ng-pristine ng-valid ng-not-empty ng-touched" name="goods_amount[]" value="0">'+
                            '</label></td>'+
                        '</tr>');
                    }
                }
            }
        } else if(num == 6){
            var all_size = $(".viewatttable tbody .att_size").size();
            var valid_count = GetCountColor();
            var average = all_size/valid_count;
            for(var i=valid_count;i>=1;i--){
                var skey = i*average-average;
                var rowspan = $(".viewatttable tbody tr").eq(skey).find("td").eq(0).attr("rowspan");
                rowspan = parseInt(rowspan)-1;
                //判断是否为第一个key(checkbox)
                if(key !=0){
                    $(".viewatttable tbody tr").eq(skey).find("td").eq(0).attr("rowspan",rowspan);
                    $(".viewatttable tbody tr").eq(skey+key).remove();
                }else{
                    var row_color = $(".viewatttable tbody tr").eq(skey).find("td").eq(0).html();
                    $(".viewatttable tbody tr").eq(skey+1).prepend('<td rowspan="'+ rowspan +'" class="layui-bg-gray text-center att_color">'+ row_color + '</td>');
                    $(".viewatttable tbody tr").eq(skey).remove();
                }
            }
        }
    };
    /*! 添加颜色数据 */
    function addColorItem(data) {
        this.$html = $($('[data-input-color]').html());
        // $(".colorblock .goods-spec-value").find(".colordrop").before(this.$html);
        // if (data) for (this.index in data) this.$html.find('[name^="' + this.index + '"]').val(data[this.index]);
        $(".colorblock .goods-spec-value").find(".colordrop").before(this.$html), setTimeout(function() {
            $.form.reInit();
        }, 50);
    };
    /*! 检测表格*/
    function checkistable() {
        if($("[data-item-size] input[name='spec-size']").is(':checked')==false || checkinputcolor() ==false){
            $(".viewatttable tbody").html("");
            return false;
        }
        return true;
    };
    /*! 检测表格*/
    function checkinputcolor(){
        var block_color = $(".colorblock .goods-spec-value .colour");
        var affect=false;
	 	for(var i=0;i<block_color.size();i++){
            if(block_color.eq(i).val()){
                var affect=true;
                break;
			}
        }
        return affect;
    }
    /*! 检测颜色*/
    function checkval(str,sor) {
        var that = $(".colorblock .goods-spec-value .colour");
        if(sor == 'size'){
            that = $("[data-item-size] input[name='spec-size']");
        }
        var affect=false;
        for(var i=0;i<that.size();i++){
            if(sor == 'size'){
                if(that.eq(i).attr('title')== str){
                    affect = true;
                    break;
                }
            } else {
                if(that.eq(i).val()== str){
                    affect = true;
                    break;
                }
            }
        }
        return affect; 
    };
    /*! */
    function checkcolor()
    {
        var colorBlock = $(".colorblock .goods-spec-value");
        colorBlock.find(".colordrop").hide();
        colorBlock.find(".colour.selected").parent(".goods-spec-color").siblings(".goods-spec-del").html("<a>删除</a>").show();
        var max = colorBlock.find(".colour").length;
        for( var i=0;i<max;i++){
            if(colorBlock.find(".colour").eq(i).hasClass("selected")){
                var index = i+1;
                break;
            }
        }
        if(max == index){
            addColorItem();
            IsmakeProducttable($(".colorblock .colour.selected").parents(".divcolor").index(),2);
        } else {
            IsmakeProducttable($(".colorblock .colour.selected").parents(".divcolor").index(),1);            
        }
    };
    function GetCountColor(){
        var ct = 0;
        $(".colorblock .goods-spec-value .colour").each(function(){
            if($(this).val().length > 0){
                ct++;
            }
        })
        return ct;
    }    
    function bachset(name){
        layer.prompt({title: '请输入数值', formType: 0}, function (value, index) {
            layer.close(index);
            if (name !='goods_amount') value = (parseFloat(value) || 0).toFixed('2');
            $("input[name='"+ name +"[]']").each(function(){
                $(this).val(value);
            })
        });
    }
</script>
{/block}
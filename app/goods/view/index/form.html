{extend name="../../admin/view/main"}
{block name="button"}
    <button data-open='{:url("index")}' class='layui-btn layui-btn-sm layui-btn-primary'>返回</button>
{/block}
{block name="content"}
    {include file='index/formstyle'}
    <form onsubmit="return false" data-auto="true" method="post" class='layui-form layui-card layui-form-pane' autocomplete="off">
        <div class="layui-card-body">
            <div class="layui-form-item">
                <label class="layui-form-label"><b>商品分类</b></label>
                <div class="layui-input-inline"><span class="layui-input">{$select_cats|raw}</span></div>
                <a data-open='{:url("category")}' class="layui-btn layui-btn-radius layui-btn-danger"><span>修改分类</span></a>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label"><b>商品属性</b></label>
                <div class="layui-input-block">
                    <table class="layui-table">
                        <thead>
                            <tr><th class="text-left">请准确填写属性，有利于商品在搜索和推荐中露出，错误填写可能面临商品下架或流量损失!</th></tr>
                            <tr>
                                <td class="text-left">
                                    <div class="layui-row margin-top-10">
                                        <div class="layui-col-md4 margin-bottom-15">
                                            <label class="layui-form-label">商品货号</label>
                                            <div class="layui-input-inline">
                                                <input type="text" name="goods_sn" value='{$vo.goods_sn|default=""}' required lay-verify="required" lay-vertype="tips" placeholder="请输入商品货号" autocomplete="off" class="layui-input">
                                            </div>
                                        </div>
                                        <div class="layui-col-md4 margin-bottom-15">
                                            <label class="layui-form-label">商品重量</label>
                                            <div class="layui-input-inline" style="width: 153px;margin-right: -1px;">
                                                <input type="text" name="goods_weight" value='{$vo.goods_weight|default=""}' required lay-verify="required" lay-vertype="tips" placeholder="请输入商品重量" autocomplete="off" class="layui-input" style="width: 153px;">
                                            </div>
                                            <div class="layui-form-mid layui-form-label layui-word-aux" style="width: 10%;">克</div>
                                        </div>
                                        <div class="layui-col-md4 margin-bottom-15">
                                            <label class="layui-form-label">品牌</label>
                                            <div class="layui-input-inline">
                                                <select name="brand_id" required lay-verify="required" lay-search>
                                                    <option value="0">请选择品牌</option>
                                                    <!-- {notempty name='goods_brand'} -->
                                                        <!-- {foreach $goods_brand as $brand} -->
                                                            <!-- {eq name='brand.id' value='$vo.brand_id|default=0'} -->
                                                                <option selected value='{$brand.id}'>{$brand.brand_name}</option>
                                                            <!-- {else} -->
                                                                <option value='{$brand.id}'>{$brand.brand_name}</option>
                                                            <!-- {/eq} -->
                                                        <!-- {/foreach} -->
                                                    <!-- {/notempty} -->
                                                </select>
                                            </div>
                                        </div>
                                        <div class="layui-col-md4 margin-bottom-15">
                                            <label class="layui-form-label">仓库</label>
                                            <div class="layui-input-inline">
                                                <select name="whouse_id" required lay-verify="required" lay-search>
                                                    <option value="0">请选择仓库</option>
                                                    <!-- {notempty name='goods_whouses'} -->
                                                        <!-- {foreach $goods_whouses as $whouse} -->
                                                            <!-- {eq name='whouse.id' value='$vo.whouse_id|default=0'} -->
                                                                <option selected value='{$whouse.id}'>{$whouse.whouse_name}</option>
                                                            <!-- {else} -->
                                                                <option value='{$whouse.id}'>{$whouse.whouse_name}</option>
                                                            <!-- {/eq} -->
                                                        <!-- {/foreach} -->
                                                    <!-- {/notempty} -->
                                                </select>
                                            </div>
                                        </div>
                                        <!-- {notempty name='goods_attr'} -->
                                            <!-- {foreach $goods_attr as $key => $attr} -->
                                                <!-- {eq name='attr.attr_type' value='1'} -->
                                                    <div class="layui-col-md4 margin-bottom-15">
                                                        <label class="layui-form-label">{$attr.attr_name}</label>
                                                        <div class="layui-input-inline">
                                                            <input type="hidden" name='attr_id[]' value="{$attr.id}">
                                                            <select name="attr_value[]"class="layui-input layui-unselect">
                                                                <option value="0">请选择</option>
                                                                <!-- {foreach $attr.attr_values as $value} -->
                                                                    <!-- {notempty name='attr_value'} -->
                                                                        <!-- {if in_array($value, $attr_value)} -->
                                                                            <option selected value='{$value}'>{$value}</option>
                                                                        <!-- {else} -->
                                                                            <option value='{$value}'>{$value}</option>
                                                                        <!-- {/if} -->
                                                                    <!-- {else} -->
                                                                        <option value='{$value}'>{$value}</option>
                                                                    <!-- {/notempty} -->
                                                                <!-- {/foreach} -->
                                                            </select>
                                                        </div>
                                                    </div>
                                                <!-- {/eq} -->
                                            <!-- {/foreach} -->
                                        <!-- {/notempty} -->
                                    </div>
                                </td>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label"><b>商品图片</b></label>
                <div class="layui-input-block">
                    <table class="layui-table">
                        <thead>
                            <tr><th class="text-left label-required-prev"><label>轮播图</label></th></tr>
                            <tr>
                                <td class="text-left"><input data-upload-images name="goods_img" type="hidden" value="{$goods_imgs|default=''}"></td>
                            </tr>
                        </thead>
                    </table>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label"><b>商品规格</b></label>
                <div class="layui-input-block goods-spec-list">
                    <!-- {notempty name='goods_attr'} -->
                        <!-- {foreach $goods_attr as $key => $attrs} -->
                            <!-- {eq name='attrs.attr_type' value='0'} -->
                                <!-- {if $key == 0} -->
                                    <div class="colorblock">
                                        <div class="goods-spec-attr goods-spec-box margin-0 relative" style="background:#eee;padding: 7px!important;">
                                            <span class="text-center">{$attrs.attr_name}</span>
                                            <span class="margin-left-10 color-desc font-s10">{$attrs.attr_notice}</span>                    
                                        </div>
                                        <div class="goods-spec-value padding-10 margin-0 layui-bg-gray block relative">
                                            <div class="color-group-wrapper color-dropdown-wrapper colordrop" style="display: none;">
                                                <div class="colorleft">
                                                    <ul class="color-group-panel">
                                                        <li class="color-tag" index-data='1' data-id="0">
                                                            <a><div class="color-block" style="background:rgb(255, 255, 255);"></div><span>白色系</span></a>
                                                        </li>
                                                        <li class="color-tag" index-data='2' data-id="1">
                                                            <a><div class="color-block" style="background:rgb(128, 128, 128);"></div><span>灰色系</span></a>
                                                        </li>
                                                        <li class="color-tag" index-data='3' data-id="2">
                                                            <a><div class="color-block" style="background:rgb(0, 0, 0);"></div><span>黑色系</span></a>
                                                        </li>
                                                        <li class="color-tag" index-data='4' data-id="3">
                                                            <a><div class="color-block" style="background:rgb(255, 0, 0);"></div><span>红色系</span></a>
                                                        </li>
                                                        <li class="color-tag" index-data='5' data-id="4">
                                                            <a><div class="color-block" style="background:rgb(255, 255, 0);"></div><span>黄色系</span></a>
                                                        </li>
                                                        <li class="color-tag" index-data='6' data-id="5">
                                                            <a><div class="color-block" style="background:rgb(0, 128, 0);"></div><span>绿色系</span></a>
                                                        </li>
                                                        <li class="color-tag" index-data='7' data-id="6">
                                                            <a><div class="color-block" style="background:rgb(0, 0, 254);"></div><span>蓝色系</span></a>
                                                        </li>
                                                        <li class="color-tag" index-data='8' data-id="7">
                                                            <a><div class="color-block" style="background:rgb(128, 0, 128);"></div><span>紫色系</span></a>
                                                        </li>
                                                        <li class="color-tag" index-data='9' data-id="8">
                                                            <a><div class="color-block" style="background:rgb(124, 75, 0);"></div><span>棕色系</span></a>
                                                        </li>
                                                    </ul>
                                                </div>
                                                <div class="colors-panel coloright">
                                                    <p class="colors-panel-title">常用标准颜色</p>
                                                    <div class="colorval">
                                                        <ul class="color-list index1">
                                                            <li class="color-tag" data-id="0">
                                                                <a><div class="color-block" style="background:rgb(255, 251, 240);"></div><span>乳白色</span></a>
                                                            </li>
                                                            <li class="color-tag" data-id="1">
                                                                <a><div class="color-block" style="background:rgb(255, 255, 2255);"></div><span>白色</span></a>
                                                            </li>
                                                            <li class="color-tag" data-id="2">
                                                                <a><div class="color-block" style="background:rgb(238, 222, 176);"></div><span>米白色</span></a>
                                                            </li>
                                                        </ul>
                                                        <ul class="color-list index2" style="display: none;">
                                                            <li class="color-tag" data-id="0">
                                                                <a><div class="color-block" style="background:rgb(255, 251, 240);"></div><span>灰色</span></a>
                                                            </li>
                                                        </ul>
                                                        <ul class="color-list index3" style="display: none;">
                                                            <li class="color-tag" data-id="0">
                                                                <a><div class="color-block" style="background:rgb(255, 251, 240);"></div><span>黑色</span></a>
                                                            </li>
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                <!-- {else} -->
                                <div class="sizeblock">                
                                    <div class="goods-spec-attr goods-spec-box margin-0 relative" style="background:#eee;padding: 7px!important;">
                                        <span class="text-center">{$attrs.attr_name}</span>
                                        <span class="margin-left-10 color-desc font-s10">{$attrs.attr_notice}</span>                    
                                    </div>
                                    <div class="goods-spec-value padding-10 margin-0 layui-bg-gray block relative">
                                        <div class="layui-tab layui-tab-card divsize" lay-filter="divsize">
                                            <ul class="layui-tab-title">
                                                <li lay-id="1" class="layui-this">欧码</li>
                                                <li lay-id="2">英码</li>
                                                <li lay-id="3">美码</li>
                                            </ul>
                                        </div>
                                        <div data-item-size>                                            
                                            <div class="goods-spec-name layui-row margin-top-10 index1">
                                                <div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
                                                    <input type="checkbox" name="spec-size" title="37" lay-filter="size" lay-skin="primary">
                                                    <input type="text" class="goods-spec-note layui-input margin-left-5 layui-hide">
                                                </div>
                                                <div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
                                                    <input type="checkbox" name="spec-size" title="37.5" lay-filter="size" lay-skin="primary">
                                                    <input type="text" class="goods-spec-note layui-input margin-left-5 layui-hide">
                                                </div>
                                                <div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
                                                    <input type="checkbox" name="spec-size" title="38" lay-filter="size" lay-skin="primary">
                                                    <input type="text" class="goods-spec-note layui-input margin-left-5 layui-hide">
                                                </div>
                                            </div>
                                            <div class="goods-spec-name layui-row margin-top-10 index2" style="display: none;">
                                                <div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
                                                    <input type="checkbox" name="spec-size" title="4" lay-filter="size" lay-skin="primary">
                                                    <input type="text" class="goods-spec-note layui-input margin-left-5 layui-hide">
                                                </div>
                                                <div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
                                                    <input type="checkbox" name="spec-size" title="5" lay-filter="size" lay-skin="primary">
                                                    <input type="text" class="goods-spec-note layui-input margin-left-5 layui-hide">
                                                </div>
                                                <div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
                                                    <input type="checkbox" name="spec-size" title="6" lay-filter="size" lay-skin="primary">
                                                    <input type="text" class="goods-spec-note layui-input margin-left-5 layui-hide">
                                                </div>
                                            </div>
                                            <div class="goods-spec-name layui-row margin-top-10 index3" style="display: none;">
                                                <div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
                                                    <input type="checkbox" name="spec-size" title="X" lay-filter="size" lay-skin="primary">
                                                    <input type="text" class="goods-spec-note layui-input margin-left-5 layui-hide">
                                                </div>
                                                <div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
                                                    <input type="checkbox" name="spec-size" title="XL" lay-filter="size" lay-skin="primary">
                                                    <input type="text" class="goods-spec-note layui-input margin-left-5 layui-hide">
                                                </div>
                                                <div class="layui-col-xs6 layui-col-sm6 layui-col-md4">
                                                    <input type="checkbox" name="spec-size" title="2XL" lay-filter="size" lay-skin="primary">
                                                    <input type="text" class="goods-spec-note layui-input margin-left-5 layui-hide">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <!-- {/if} -->
                            <!-- {/eq} -->
                        <!-- {/foreach} -->
                    <!-- {/notempty} -->
                    <table class="layui-table viewatttable">
                        <thead>
                            <tr>
                                <!-- {notempty name='goods_attr'} -->
                                    <!-- {foreach $goods_attr as $key => $attrs} -->
                                        <!-- {eq name='attrs.attr_type' value='0'} -->
                                            <th width="20%" class="text-center nowrap">{$attrs.attr_name}</th>
                                        <!-- {/eq} -->
                                    <!-- {/foreach} -->
                                <!-- {/notempty} -->
                                <th width="15%" class="text-center nowrap">销售价格<a data-tips-text="批量设置" class="layui-icon">&#xe63c;</a></th>
                                <th width="15%" class="text-center nowrap">分销价格<a data-tips-text="批量设置" class="layui-icon">&#xe63c;</a></th>
                                <th width="15%" class="text-center nowrap">库存<a data-tips-text="批量设置" class="layui-icon">&#xe63c;</a></th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
            <div class="layui-form-item">
                <label class="layui-form-label"><b>商品详情</b></label>
                <div class="layui-input-block"><textarea name="content">{$goods_content|default=''|raw}</textarea></div>
            </div>
            <div data-item-tpl class="layui-hide">
                <div class="layui-display-flex divcolor">
                    <div class="goods-spec-color">
                        <input type="text" name="attr-value[]" autocomplete="off" placeholder="选择或输入主色" class="layui-input colour">
                    </div>
                    <div class="goods-spec-note margin-left-10">
                        <input type="text" name="attr-value-note[]" placeholder="备注(如偏深偏浅等)" autocomplete="off" class="layui-input">
                    </div>
                    <div class="goods-spce-image margin-left-10">
                        <input data-upload-image name="img[]" type="hidden">
                    </div>
                    <div class="goods-spec-del margin-left-10" style="line-height: 38px;"></div>
                </div>
            </div>
            <label class="layui-hide">
                <textarea id="DefaultData">{$data|default=[]|json_encode}</textarea>
            </label>
            {notempty name='vo.goods_id'}<input type='hidden' value='{$vo.goods_id}' name='goods_id'>{/notempty}
            <input type='hidden' value='{$vo.cat_id|default=input("cat_id",0)}' name='cat_id'>
            <input type='hidden' value='{:session("user.id")}' name='user_id'>
            <div class="layui-form-item text-center">
                <button class="layui-btn" type='submit'>保存数据</button>
                <button class="layui-btn layui-btn-danger" type='button' data-open='{:url("index")}'>取消编辑</button>
            </div>
        </div>
    </form>
{/block}
{block name='script'}
<script>
    (function(data) {
        /*! 表单初始化 */
        window.form.render();
        /*! 加载扩展插件 */
        require(['ckeditor', 'angular'], function () {
            // 富文本加载
            window.createEditor('[name="content"]', {height: 400});
        });
        /*! 默认数据渲染 */
        if (data.length < 1) addItem();
        else data.forEach(function (item) {
            addItem(item)
        });
        /*! 初始化上传插件 */
        (function initUpload() {
            $('.goods-spec-value input[data-upload-image]').map(function () {
                if (!$(this).attr('inited')) $(this).attr('inited', true).uploadOneImage();
            });
            $('.layui-table input[data-upload-images]').map(function () {
                if (!$(this).attr('inited')) $(this).attr('inited', true).uploadMultipleImage();
            });
            setTimeout(initUpload, 100);
        })();
        /*! 显示颜色框*/
        var colorBlock = $(".colorblock .goods-spec-value");
        colorBlock.delegate(".colour","click",function(){
            if($.trim($(this).val()).length == 0) {
                var index = colorBlock.find(".colour").index(this);
                colorBlock.find(".colordrop").show().css("top",index*45+45);
            }
            $(this).addClass("selected").parents(".divcolor").siblings().find(".colour").removeClass("selected");
            $(this).keyup(function(){
                if($.trim($(this).val()).length==0){
                    $(".viewatttable tbody .tr_"+colorBlock.find(".colour").index(this)).remove();
                    checkistable();
                }
            });
        }).delegate(".colordrop", "mouseleave", function(){
            colorBlock.find(".colordrop").hide();
        }).delegate(".colour", "blur", function(){
            if($.trim($(this).val()).length > 0) {
                checkcolor();
            }
        });
        /*!  颜色值点击*/
        colorBlock.find(".colorval ul li").click(function(){
            if(checkval($(this).text()) == true){
                layer.tips('与其他颜色重复，请修改!', $(this),{tips:[2,"#FF6A6A"]});
                return false;
            };
            colorBlock.find(".colour.selected").val($(this).text());
            colorBlock.find(".colour.selected").attr("data-id",$(this).attr("data-id"));
            checkcolor();
        });
        /*! 颜色左边移动*/
        $(".colorblock .colorleft ul li").mouseover(function(){
            var nums = parseInt($(this).attr("index-data"));
            $(".colorblock .coloright .colorval ul").each(function(index){
                if(nums == index+1){
                    $(this).show().siblings().hide();
                }
            })
        });
        /*! 删除颜色*/
        $(".colorblock").delegate(".goods-spec-del a","click",function(){
            var remove_key = $(".colorblock .goods-spec-del a").index(this);
            $(this).parents(".divcolor").remove();
            $(".colorblock .colordrop").hide();
            // 删除表格属性
        });

        // 切换码型
        layui.use('element', function() {
            var element = layui.element;
            //监听Tab切换
            element.on('tab(divsize)', function(){
                var layid = this.getAttribute('lay-id');
                var title = this.innerHTML;
                layer.open({
                    type: 1
                    ,title: '确认操作'
                    ,closeBtn: false
                    ,area: '300px;'
                    ,shade: 0.8
                    ,id: 'LAY_layuipro'
                    ,btn: ['确认', '取消']
                    ,btnAlign: 'c'
                    ,moveType: 1
                    ,content: '<div style="padding:20px;line-height:22px;background-color:#fff;border-bottom:1px solid #eee;color:#000;font-weight:300;">切换尺码分组将会丢失勾选的尺码及 商品属性 数据，确定切换？</div>'
                    ,yes: function(index){
                        $("[data-item-size]").find(".index" + layid).show().siblings().hide();
					    $(".viewatttable").find("tbody").html('');
					    layer.close(index);
                    }
                });
            });
        });
        // 尺码勾选
        form.on('checkbox(size)', function(data){
            if(this.checked){
                $(this).siblings(".goods-spec-note").removeClass('layui-hide');
				// IsmakeProducttable($(".sizeblock .sizeselect .howsize:checked").index(this),5);
            } else {
                $(this).siblings(".goods-spec-note").addClass('layui-hide');
            }
        });
    })(JSON.parse($('#DefaultData').val() || '[]') || []);    
    /*! 检测表格*/
    function IsmakeProducttable(key,num){
        if(checkistable() == false){
            return false;
        }
    };
    /*! 添加数据选项 */
    function addItem(data) {
        this.$html = $($('[data-item-tpl]').html());
        // $(".colorblock .goods-spec-value").find(".colordrop").before(this.$html);
        // if (data) for (this.index in data) this.$html.find('[name^="' + this.index + '"]').val(data[this.index]);
        $(".colorblock .goods-spec-value").find(".colordrop").before(this.$html), setTimeout(function() {
            $.form.reInit();
        }, 100);
    };
    /*! 检测表格*/
    function checkistable() {
        if($(".sizeblock .sizemore .howsize").is(':checked')==false || checkinputcolor() ==false){
            $(".viewatttable tbody").html('');
            $(".viewatttable").hide();
            return false;
        }
        return true;
    };
    /*! 检测颜色*/
    function checkval(str) {
        var that = $(".colorblock .goods-spec-value .colour");
        var affect=false;
        for(var i=0;i<that.size();i++){
            if(that.eq(i).val()== str){
                affect = true;
                break;
            }
        }
        return affect; 
    };
    /*! */
    function checkcolor()
    {
        var colorBlock = $(".colorblock .goods-spec-value");
        colorBlock.find(".colordrop").hide();
        colorBlock.find(".colour.selected").parent(".goods-spec-color").siblings(".goods-spec-del").html("<a>删除</a>").show();
        var max = colorBlock.find(".colour").length;
        for( var i=0;i<max;i++){
            if(colorBlock.find(".colour").eq(i).hasClass("selected")){
                var index = i+1;
                break;
            }
        }
        if(max == index){
            addItem();
        } else {
            
        }
    };
</script>
{/block}